<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedTax - Contabilidad Médica</title>
    <style>
        /* Styles unchanged... */
        /* (Same CSS as before) */
    </style>
</head>
<body>
    <div class="device-frame">
        <!-- Pantalla 1: Facturación -->
        <div class="screen active" id="facturacion">
            <div class="screen-container">
                <div class="status-bar"><span>9:41</span><span>📶 📶 📶 🔋</span></div>
                <div class="header">
                    <h1>💳 Facturación</h1>
                    <p>Genera y gestiona tus CFDIs</p>
                </div>
                <div class="content">
                    <button class="btn" onclick="showNewInvoice()">🆕 Emitir CFDI</button>
                </div>
            </div>
        </div>

        <!-- Pantalla 2: Conciliación -->
        <div class="screen" id="conciliacion">
            <div class="screen-container">
                <div class="status-bar"><span>9:41</span><span>📶 📶 📶 🔋</span></div>
                <div class="header">
                    <h1>🏦 Conciliación</h1>
                    <p>Concilia tus movimientos bancarios</p>
                </div>
                <div class="content">
                    <!-- Filtros -->
                    <div class="card">
                        <h3>Filtros</h3>
                        <div class="input-group"><label>Fecha</label><input type="date" id="filterDate"></div>
                        <div class="input-group"><label>Monto</label><input type="number" id="filterAmount" placeholder="0.00"></div>
                        <div class="input-group">
                            <label>Estatus</label>
                            <select id="filterStatus">
                                <option value="all">Todos</option>
                                <option value="conciliado">Conciliado</option>
                                <option value="no-conciliado">No conciliado</option>
                            </select>
                        </div>
                        <button class="btn" onclick="applyFilters()">Aplicar</button>
                    </div>
                    <div class="card">
                        <h3>Movimientos Bancarios</h3>
                        <div id="transactionsList">
                            <!-- Cargado dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pantalla 3: Declaraciones -->
        <div class="screen" id="declaraciones">
            <div class="screen-container">
                <div class="status-bar"><span>9:41</span><span>📶 📶 📶 🔋</span></div>
                <div class="header">
                    <h1>📋 Declaraciones</h1>
                    <p>Presenta tus obligaciones fiscales</p>
                </div>
                <div class="content">
                    <div class="card">
                        <h3>Declaración Mensual</h3>
                        <!-- Campos prellenados desde CFDIs -->
                        <div class="input-group"><label>CFDI Referencia</label><input type="text" id="prefillCFDI" readonly></div>
                        <div class="input-group"><label>Período</label><select id="declPeriod"><option>Julio 2025</option><option>Junio 2025</option></select></div>
                        <div class="input-group"><label>Tipo</label><select id="declType"><option>Mensual</option><option>Anual</option></select></div>
                        <button class="btn" onclick="activateBiometry()">🔒 Firmar con e.firma</button>
                    </div>
                    <div class="card">
                        <h3>Historial</h3>
                        <!-- Historial dinámico -->
                        <div id="declarationHistory"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pantalla 4: Chatbot -->
        <div class="screen" id="chatbot">
            <div class="screen-container">
                <div class="status-bar"><span>9:41</span><span>📶 📶 📶 🔋</span></div>
                <div class="header">
                    <h1>🤖 Asistente Fiscal</h1>
                    <p>Resuelve tus dudas al instante</p>
                </div>
                <div class="content">
                    <div class="chat-container" id="chatContainer"></div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Escribe tu pregunta..." />
                        <button onclick="sendMessage()">Enviar</button>
                    </div>
                    <button class="btn btn-secondary" onclick="contactSupport()">👤 Contactar soporte humano</button>
                </div>
            </div>
        </div>

        <!-- Pantalla 5: Notificaciones -->
        <div class="screen" id="notificaciones">
            <div class="screen-container">
                <div class="status-bar"><span>9:41</span><span>📶 📶 📶 🔋</span></div>
                <div class="header">
                    <h1>🔔 Notificaciones</h1>
                    <p>Mantente al día con tus obligaciones</p>
                </div>
                <div class="content">
                    <div class="card" id="notificationsList"></div>
                    <div class="card">
                        <h3>Configurar Notificaciones</h3>
                        <div class="input-group"><label><input type="checkbox" id="optPush"> Push Notifications</label></div>
                        <div class="input-group"><label><input type="checkbox" id="optEmail"> Email</label></div>
                        <div class="input-group"><label><input type="checkbox" id="optWhats"> WhatsApp</label></div>
                        <button class="btn btn-secondary" onclick="saveNotificationSettings()">Guardar Configuración</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navegación -->
        <div class="navigation">
            <div class="nav-item active" onclick="showScreen('facturacion')"><div class="nav-icon">💳</div><div class="nav-text">Facturación</div></div>
            <div class="nav-item" onclick="showScreen('conciliacion')"><div class="nav-icon">🏦</div><div class="nav-text">Conciliación</div></div>
            <div class="nav-item" onclick="showScreen('declaraciones')"><div class="nav-icon">📋</div><div class="nav-text">Declaraciones</div></div>
            <div class="nav-item" onclick="showScreen('chatbot')"><div class="nav-icon">🤖</div><div class="nav-text">Asistente</div></div>
            <div class="nav-item" onclick="showScreen('notificaciones')"><div class="nav-icon">🔔</div><div class="nav-text">Notificaciones</div></div>
        </div>
    </div>

    <script>
        // Common
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
        }

        // FACTURACIÓN
        function showNewInvoice() {
            const content = document.querySelector('#facturacion .content');
            content.innerHTML = `
                <div class="card">
                    <h3>Emitir CFDI</h3>
                    <div class="input-group"><label>RFC</label><input type="text" id="invRFC"></div>
                    <div class="input-group"><label>Nombre del paciente</label><input type="text" id="invName"></div>
                    <div class="input-group"><label>Monto</label><input type="number" id="invAmount"></div>
                    <div class="input-group"><label>Concepto</label><input type="text" id="invConcept"></div>
                    <div class="input-group"><label>Uso del CFDI</label><select id="invUse"><option>G03</option><option>P01</option></select></div>
                    <button class="btn" onclick="emitCFDI()">🆗 Emitir CFDI</button>
                </div>`;
        }
        function emitCFDI() {
            // Aquí conectarías con Finkok API
            alert('Conectando con Finkok...');
            setTimeout(previewPDF, 1000);
        }
        function previewPDF() {
            // Vista previa del PDF (stub)
            alert('Mostrando vista previa del CFDI en PDF');
        }

        // CONCILIACIÓN
        let transactions = [
            { id: 1, desc: 'Depósito - Paciente Anónimo', date: '2025-07-16', amount: 1200, status: 'no-conciliado' },
            { id: 2, desc: 'Transferencia SPEI', date: '2025-07-15', amount: 2250, status: 'no-conciliado' }
        ];
        function renderTransactions(list) {
            const container = document.getElementById('transactionsList');
            container.innerHTML = '';
            list.forEach(tx => {
                const div = document.createElement('div');
                div.className = 'transaction-item';
                div.innerHTML = `
                    <div class="transaction-info">
                        <h4>${tx.desc}</h4>
                        <p>${tx.date}</p>
                        <span class="status-badge ${tx.status === 'conciliado' ? 'status-success' : 'status-warning'}">\${tx.status === 'conciliado' ? 'Conciliado' : 'No conciliado'}</span>
                    </div>
                    <div class="transaction-amount">$${tx.amount.toFixed(2)}</div>
                    <button class="btn btn-secondary" onclick="conciliateTransaction(${tx.id})">Conciliar</button>
                `;
                container.appendChild(div);
            });
        }
        function applyFilters() {
            const date = document.getElementById('filterDate').value;
            const amt = parseFloat(document.getElementById('filterAmount').value) || 0;
            const status = document.getElementById('filterStatus').value;
            let filtered = transactions;
            if (date) filtered = filtered.filter(tx => tx.date === date);
            if (amt) filtered = filtered.filter(tx => tx.amount === amt);
            if (status !== 'all') filtered = filtered.filter(tx => tx.status === status);
            renderTransactions(filtered);
        }
        function conciliateTransaction(id) {
            const tx = transactions.find(t => t.id === id);
            if (tx) {
                tx.status = 'conciliado';
                renderTransactions(transactions);
                alert(`Movimiento ${id} conciliado`);
            }
        }
        document.addEventListener('DOMContentLoaded', () => { renderTransactions(transactions); });

        // DECLARACIONES
        function activateBiometry() {
            if (window.PublicKeyCredential) {
                alert('Iniciando autenticación biométrica...');
                // Integrar WebAuthn aquí
            } else {
                alert('Biometría no disponible, usar contraseña de e.firma');
            }
        }
        // Prefill example
        document.getElementById('prefillCFDI')?.setAttribute('value', 'A001-2024-001238');

        // CHATBOT
        function sendMessage() {
            const inp = document.getElementById('chatInput');
            if (!inp.value) return;
            const cont = document.getElementById('chatContainer');
            cont.innerHTML += `<div class="chat-message user"><div class="chat-bubble user">${inp.value}</div></div>`;
            inp.value = '';
            setTimeout(() => {
                cont.innerHTML += `<div class="chat-message"><div class="chat-bubble bot">Consultando a Rasa...</div></div>`;
                cont.scrollTop = cont.scrollHeight;
            }, 500);
        }
        function contactSupport() {
            window.location.href = 'mailto:atsushi@tuempresa.com?subject=Soporte%20Humano';
        }

        // NOTIFICACIONES
        let notifications = [
            { icon: '⚠️', title: 'Pago no conciliado', msg: 'Depósito de $1,200 sin factura asociada', time: '15 min' }
        ];
        function renderNotifications() {
            const list = document.getElementById('notificationsList'); list.innerHTML = '';
            notifications.forEach(n => {
                const div = document.createElement('div'); div.className = 'notification-item';
                div.innerHTML = `<div class="notification-icon warning">${n.icon}</div><div class="notification-content"><h4>${n.title}</h4><p>${n.msg}</p></div><div class="notification-time">${n.time}</div>`;
                list.appendChild(div);
            });
        }
        function saveNotificationSettings() {
            const settings = {
                push: document.getElementById('optPush').checked,
                email: document.getElementById('optEmail').checked,
                whats: document.getElementById('optWhats').checked
            };
            console.log('Settings saved', settings);
            alert('Configuración guardada');
        }
        document.addEventListener('DOMContentLoaded', () => { renderNotifications(); });
    </script>
</body>
</html>
